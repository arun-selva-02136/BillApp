{% comment %} <!-- my_template.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modify Data Example</title>
</head>
<body>
    <h1>Modify Data Example</h1>

    <ul id="data-list">
        {% for item in data_to_modify %}
            <li>{{ item }}</li>
        {% endfor %}
    </ul>

    <button id="modify-button">Modify Data</button>

<form method="post" action="{% url 'handle_modified_data' %}">
    {% csrf_token %}
    <!-- Other form fields -->
    <div id="PRODUCTS">
    {% for product in products %}
                <tr>
                        <td>{{ product.product_id }}</td>
                        {% comment %} <td>{{ product.quantity }}</td> {% endcomment %}
                        {% comment %} <td> {{product.qty}} </td>
                        <td>{{ product.unit }}</td>
                        <td>{{ product.total_amount }}</td>
                    </tr>
                {% endfor %}
                </div>
    <input type="hidden" id="modified-data-input" name="modified_data" value="">
    <button type="submit">Submit</button>
</form> {% endcomment %}
{% comment %} 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var dataList = document.getElementById('data-list');
        var modifiedDataInput = document.getElementById('modified-data-input');
        var modifyButton = document.getElementById('modify-button');

        // Example JavaScript to modify the data
        modifyButton.addEventListener('click', function() {
            // Clear the existing items
            dataList.innerHTML = '';

            // Append new items based on the products data
            {% for product in products %}
                var newItem{{ forloop.counter }} = document.createElement('li');
                newItem{{ forloop.counter }}.textContent = '{{ product.product_id }} - {{ product.quantity }} - {{ product.unit }} - {{ product.total_amount }}';
                dataList.appendChild(newItem{{ forloop.counter }});
            {% endfor %}

            // Update the hidden input with the modified data
            var modifiedData = [...dataList.children].map(li => [li.textContent]);
            modifiedDataInput.value = JSON.stringify(modifiedData);
        });
    });
</script>  {% endcomment %}
<!--Future try  Other form fields -->
{% comment %} <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Simulate the creation of PRODUCTS using JavaScript
        var productsDiv = document.getElementById('PRODUCTS');
        for (var i = 0; i < 5; i++) {
            var product = document.createElement('tr');
            product.innerHTML = `
                <td>Product ID ${i}</td>
                <td>Qty ${i}</td>
                <td>Unit ${i}</td>
                <td>Total Amount ${i}</td>
            `;
            productsDiv.appendChild(product);
        }

        var modifyButton = document.getElementById('modify-button');
        modifyButton.addEventListener('click', function() {
            var dataList = document.getElementById('data-list');
            var modifiedDataInput = document.getElementById('modified-data-input');

            // Clear the existing items
            dataList.innerHTML = '';

            // Append new items based on the products data
            var products = productsDiv.getElementsByTagName('tr');
            for (var i = 0; i < products.length; i++) {
                var newItem = document.createElement('li');
                newItem.textContent = products[i].textContent;
                dataList.appendChild(newItem);
            }

            // Update the hidden input with the modified data
            var modifiedData = [...dataList.children].map(li => [li.textContent]);
            modifiedDataInput.value = JSON.stringify(modifiedData);
        });
    });
</script> {% endcomment %}








<!DOCTYPE html>
<html lang="en">

<head>

    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill</title>
    <link rel="stylesheet" href="{% static 'css/product/bill_manage.css'%}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/4723418bde.js" crossorigin="anonymous"></script>
    <style>
    #autocomplete-popup {
      display: none;
      position: absolute;
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      background-color: #fff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .suggestion {
      padding: 8px;
      cursor: pointer;
    }

    .suggestion:hover,
    .suggestion.selected {
      background-color: #f5f5f5;
    }
  </style>
</head>

<body>
    <div class="container-xxl">
        <header>
            <div class="row pt-2">
                <div class="col-sm-3">
                    <div class="col-12  d-flex flex-column align-items-left justify-content-center">
                        <h5>Address :</h5>
                        <h6>Vadakumadevi Perambalur , <br> Pincode -606 110. <br> Ph : 1234567890</h6>
                    </div>
                </div>
                <div class="col-sm-5  d-flex align-items-center justify-content-center">
                    <img src="../Images/Cloug-logo.png" alt="">
                </div>
                <div class="col-sm-4 mt-1" style="padding-left: 6rem;">
                    <div class="col-12  d-flex flex-column align-items-left justify-content-center">
                        <div class="col d-flex text-left">
                            <h6>Bill No : <span id="orderNumber"></span></h6>
                        </div>
                        <div class="col d-flex text-left">
                            <h6>Date Time : <span id="currentDateTime"></span></h6>
                        </div>
                        <div class="col d-flex text-left">
                            <h6>GST No : <span id="GSTon">875643251</span></h6>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Billing Header Part -->
        <hr>
        <!-- Customer Details -->
        
        <div class="row">
            <div class="col-sm-9 customer-info d-flex flex-column align-items-left justify-content-center">
                <div class="col mb-2">

                    <label for="CustomerName">Customer Name <span>:</span> </label>
                    <input type="text" name="" id="CustomerName" onkeyup="showAutocomplete(this.value)">
                    <div id="autocomplete-popup"></div>
                </div>
                <div class="col mb-2">
                    <label for="CustomerNumber">Customer Phone No <span>:</span></label>
                    <input type="number" name="" id="CustomerNumber">
                </div>
            </div>
            <div class="col-sm-3 d-flex align-items-center justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                    <i class="fa-solid fa-user-plus me-1" style="color: white;"></i>Add Customer
                </button>
                <!-- Modal -->
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Add Customer</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body d-flex flex-column">
                                <form class="row g-3 needs-validation"  method="POST" action="{% url 'customer' %}" novalidate>
                                    {% csrf_token %}
                                    <div class="col-md-12">
                                      <label for="validationCustomUsername" class="form-label">Username</label>
                                      <div class="input-group has-validation">
                                        <span class="input-group-text" id="inputGroupPrepend">@</span>
                                        <input type="text" class="form-control" name="customer_name" id="validationCustomUsername" aria-describedby="inputGroupPrepend" required>
                                        <div class="invalid-feedback">
                                          Please choose a username.
                                        </div>
                                      </div>
                                    </div>
                                    <div class="col-md-12">
                                      <label for="validationCustom03" class="form-label">Phone No</label>
                                      <input type="number" class="form-control" name="customer_number" id="validationCustom03" required>
                                      <div class="invalid-feedback">
                                        Please provide a valid Number.
                                      </div>
                                    </div>
                                    <div class="col-12">
                                      <button class="col-sm-12 btn btn-success" type="submit">Save</button>
                                      <p style="font-size: 10px; text-align: center; margin: 10px auto;">Save Your Customer Deatils</p>
                                    </div>
                                  </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <button type="button" class="btn btn-primary" style="height: 3rem;"></button> -->
            </div>
        </div>
        <!-- Customer Details -->
        <!-- Products Details Table-->
        <form id="myForm" onsubmit="logTableData(); return false;">
        <div class="col-sm-12 table-responsive" id="table-container">
            <table id="product-table">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Product Name</th>
                        <th>HNS Code</th>
                        <th>Qty</th>
                        <th>SGST No</th>
                        <th>CGST No</th>
                        <th>Amount</th>
                        <th>Discount Amount</th>
                        <th>Net Amount</th>
                        <th style='display:none;' >Product ID</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Static rows for entering product details -->
                    <tr class="product-row">
                        <td><span class="sno">1</span></td>
                        <td><input type="text" class="product-name-input" placeholder="Product Name"></td>
                        <td><input type="text" placeholder="HNS Code" class="HSN" readonly></td>
                        <td><input type="number" placeholder="Qty" class="qty-input" oninput="calculateRow(this)"></td>
                        <td><input type="text" class="sgst-no-input" placeholder="SGST No" readonly></td>
                        <td><input type="text" placeholder="CGST No" class="CGST" readonly></td>
                        <td><input type="number" placeholder="Amount" class="amount-input" oninput="calculateRow(this)" readonly></td>
                        <td><input type="text" placeholder="Discount Amount"  class="discount-amount-input" readonly oninput="calculateRow(this)"></td>
                        <td><span class="net-amount">0.00</span></td>
                        <td   style="display:none;" ><span  id="product_id" class="pro_id"></span></td>
                    </tr>
                    <!-- Popup screen -->
                    <div id="productList"></div>
                    <!-- Popup screen -->
                    <tr class="product-row">
                        <td><span class="sno">2</span></td>
                        <td><input type="text" class="product-name-input" placeholder="Product Name"></td>
                        <td><input type="text" placeholder="HNS Code" class="HSN" readonly></td>
                        <td><input type="number" placeholder="Qty" class="qty-input" oninput="calculateRow(this)"></td>
                        <td><input type="text" class="sgst-no-input" placeholder="SGST No" readonly></td>
                        <td><input type="text" placeholder="CGST No" class="CGST" readonly></td>
                        <td><input type="number" placeholder="Amount" class="amount-input" readonly oninput="calculateRow(this)"></td>
                        <td><input type="text" placeholder="Discount Amount" readonly   class="discount-amount-input" oninput="calculateRow(this)"></td>
                        <td><span class="net-amount">0.00</span></td>
                        <td   style="display:none;" ><span  id="product_id" class="pro_id"></span></td>

                    </tr>
                    <tr class="product-row">
                        <td><span class="sno">3</span></td>
                        <td><input type="text" class="product-name-input" placeholder="Product Name"></td>
                        <td><input type="text" placeholder="HNS Code" class="HSN" id="hns-code-total" readonly></td>
                        <td><input type="number" placeholder="Qty" class="qty-input" oninput="calculateRow(this)"></td>
                        <td><input type="text" id="sgst-no-total" class="sgst-no-input" placeholder="SGST No readonly"></td>
                        <td><input type="text" placeholder="CGST No" id="cgst-no-total" class="CGST" readonly></td>
                        <td><input type="number" placeholder="Amount" class="amount-input" readonly oninput="calculateRow(this)"></td>
                        <td><input type="text" placeholder="Discount Amount" readonly    class="discount-amount-input" oninput="calculateRow(this)"></td>
                        <td><span class="net-amount">0.00</span></td>
                        <td style="display:none;" ><span class="pro_id"></span></td>

                    </tr>
                    <tr class="product-row">
                        <td><span class="sno">4</span></td>
                        <td><input type="text" class="product-name-input" placeholder="Product Name"></td>
                        <td><input type="text" placeholder="HNS Code" class="HSN" readonly></td>
                        <td><input type="number" placeholder="Qty" class="qty-input" oninput="calculateRow(this)"></td>
                        <td><input type="text" class="sgst-no-input" placeholder="SGST No" readonly></td>
                        <td><input type="text" placeholder="CGST No" class="CGST" readonly></td>
                        <td><input type="number" placeholder="Amount" readonly class="amount-input" oninput="calculateRow(this)"></td>
                        <td><input type="text" placeholder="Discount Amount"  readonly   class="discount-amount-input" oninput="calculateRow(this)"></td>
                        <td><span class="net-amount">0.00</span></td>
                        <td style="display:none;" ><span class="pro_id"></span></td>

                    </tr>
                    <!-- Popup screen -->
                    <div id="productNamePopup" class="popup">
                        <ul id="productNameList"></ul>
                    </div>
                <!-- Popup screen -->
                </tbody>
                <tfoot>
                    <tr>
                        <td><h4>Total</h4></td>
                        <td class="text-center"><span id="product-list-length">0</span></td>
                        <td></td>
                        <td> <span id="qty-total">0</span></td>
                        <td> <span class="sgst-no-total">0.00</span></td>
                        <td><span class="cgst-no-total">0.00</span></td>
                        <td> <span id="total-amount">0.00</span></td>
                        <td> <span id="total-discount-amount">0.00</span></td>
                        <td> <span id="total-net-amount">0.00</span></td>
                        <!-- <td>Overall Total: <span id="overall-total">0.00</span></td> -->
                        <!-- HNS Code Total: <span id="hns-code-total">0.00</span> -->
                    </tr>
                </tfoot>
            </table>
        </div>
        <!-- Products Details Table-->
        <!-- Overall Details -->
        <div class="row mt-4 ms-5">
            <div class="col-sm-4">
                <div class="col-sm-12 d-flex flex-column align-items-left justify-content-center">
                    <div class="col mb-2">
                        <label for="">SGST :</label>
                        <span id="SGST"></span>
                    </div>
                    <div class="col mb-2">
                        <label for="">DisCount :</label>
                        <span id="discount"></span>
                    </div>
                    <div class="col mb-2">
                        <label for="">Amount :</label>
                        <input type="number" id="amount-input" oninput="calculateTotals()" style="border: 0;outline: 0;"/>
                        <!-- <span id="amount"></span> -->
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="col-sm-12 d-flex flex-column align-items-left justify-content-center">
                    <div class="col mb-2">
                        <label for="">CGST :</label>
                        <span id="Cgst"></span>
                    </div>
                    <div class="col mb-2">
                        <label for="">Balance :</label>
                        <span id="balance"></span>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="col-sm-12 d-flex flex-column align-items-left justify-content-center">
                    <div class="col mb-2">
                        <label for="">GST Amount :</label>
                        <span id="gstAmount"></span>
                    </div>
                    <div class="col mb-2">
                        <label for="">Discount Amount :</label>
                        <span id="DiscountAmount"></span>
                    </div>
                    <div class="col mb-2">
                        <label for="">Total Amount :</label>
                        <span id="total"></span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Overall Details -->
        <!-- Pay Button -->
        <div class="col-sm-12">
            <div class="row mx-auto mt-5 mb-5">
                <button type="submit" id="payAmount" class="btn btn-primary" style="height: 3rem; font-size: 20px;">Pay Amount</button>
            </div>
        </div>
        </form>
        <!-- Pay Button -->
    </div>
    <script>

    function calculateRow(input) {
        var row = input.closest('tr');
        var productName = row.querySelector('td:nth-child(2) input').value.trim();
        var qty = parseFloat(row.querySelector('td:nth-child(4) input').value) || 0;
        var hnsCode = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
        var sgstNo = parseFloat(row.querySelector('td:nth-child(5) input').value) || 0;
        var cgstNo = parseFloat(row.querySelector('td:nth-child(6) input').value) || 0;
        var amount = parseFloat(row.querySelector('td:nth-child(7) input').value) || 0;
        var discountAmount = parseFloat(row.querySelector('td:nth-child(8) input').value) || 0;
        var Empty = (amount * cgstNo /100)
        var diScount = (amount * discountAmount /100)
        var netAmount = (Empty + amount - diScount) * qty;
      
      
        row.querySelector('td:nth-child(9) span.net-amount').textContent = netAmount.toFixed(2);
      
        // Update HNS code, SGST No, CGST No totals
        // var hnsCodeTotal = calculateColumnTotal(3);
        var qtyTotal = calculateColumnTotal(4);
        var sgstNoTotal = calculateColumnTotal(5);
        var cgstNoTotal = calculateColumnTotal(6);
      
        // Calculate totals for all rows
        var totalNetAmount = 0;
        var totalQty = 0;
        var totalSgstNo = 0;
        var totalCgstNo = 0;
        var totalGstAmount = 0;
        var totalDiscountAmount = 0;
      
        // Iterate through all rows
        document.querySelectorAll('.product-row').forEach(function (row) {
          var currentQty = parseFloat(row.querySelector('td:nth-child(4) input').value) || 0;
          var currentHnsCode = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
          var currentSgstNo = parseFloat(row.querySelector('td:nth-child(5) input').value) || 0;
          var currentCgstNo = parseFloat(row.querySelector('td:nth-child(6) input').value) || 0;
          var currentAmount = parseFloat(row.querySelector('td:nth-child(7) input').value) || 0;
          var currentDiscountAmount = parseFloat(row.querySelector('td:nth-child(8) input').value) || 0;
      
          totalQty += currentQty;
          totalSgstNo += currentSgstNo;
          totalCgstNo += currentCgstNo;
      
          var currentEmpty = (currentAmount * currentCgstNo / 100);
          var currentDiscount = (currentAmount * currentDiscountAmount / 100);
          var currentNetAmount = (currentEmpty + currentAmount - currentDiscount) * currentQty;
      
          totalNetAmount += currentNetAmount;
          totalGstAmount += currentEmpty;
          totalDiscountAmount += currentDiscount;
        });
      
        // document.getElementById('hns-code-total').textContent = hnsCodeTotal.toFixed(2);
        document.getElementById('qty-total').textContent = qtyTotal.toFixed();
        document.querySelector('.sgst-no-total').textContent = `${sgstNoTotal.toFixed('')}%`;
        document.querySelector('.cgst-no-total').textContent = `${cgstNoTotal.toFixed('')}%`;
      
        document.getElementById('SGST').textContent = `${sgstNoTotal.toFixed('')}%`;
        document.getElementById('Cgst').textContent = `${cgstNoTotal.toFixed('')}%`;
        document.getElementById('gstAmount').textContent = totalGstAmount.toFixed(1);
        document.getElementById('DiscountAmount').textContent = totalDiscountAmount.toFixed(1);
      
        // Add a new row if the last row is filled
       // Add a new row if the last row is filled based on qty
      if (qty > 0 && input === row.querySelector('td:nth-child(4) input')) {
        var tableBody = document.getElementById('table-body');
        var lastRow = tableBody.lastElementChild;
        var qtyInput = lastRow.querySelector('td:nth-child(4) input');
        
        if (qtyInput.value.trim() !== "") {
          var newRow = document.createElement('tr');
          newRow.classList.add('product-row');
          newRow.innerHTML = row.innerHTML;
          var span = newRow.querySelector('.sno');
          span.textContent = tableBody.childElementCount + 1;
      
          newRow.querySelectorAll('input').forEach(function (input) {
            input.value = '';
          });
      
          newRow.querySelectorAll('.net-amount').forEach(function (span) {
            span.textContent = '0.00';
          });
      
          tableBody.appendChild(newRow);
        }
      }
      
      
        // Update totals
        calculateTotals();
      }
      
      function calculateColumnTotal(columnIndex) {
        var rows = document.querySelectorAll('#product-table tbody tr.product-row');
        var total = 0;
      
        rows.forEach(function (row) {
          var value = parseFloat(row.querySelector('td:nth-child(' + columnIndex + ') input').value) || 0;
          total += value;
        });
      
        return total;
      }
      
      function calculateTotals() {
        var rows = document.querySelectorAll('#product-table tbody tr.product-row');
        var productListLength = 0;
        var totalAmount = 0;
        var totalDiscountAmount = 0;
        var totalNetAmount = 0;
      
        rows.forEach(function (row) {
          var productName = row.querySelector('td:nth-child(2) input').value.trim();
          if (productName !== "") {
            productListLength++;
          }
      
          var qty = parseFloat(row.querySelector('td:nth-child(4) input').value) || 0;
          var sgstNo = parseFloat(row.querySelector('td:nth-child(5) input').value) || 0;
          var cgstNo = parseFloat(row.querySelector('td:nth-child(6) input').value) || 0;
          var amount = parseFloat(row.querySelector('td:nth-child(7) input').value) || 0;
          var discountAmount = parseFloat(row.querySelector('td:nth-child(8) input').value) || 0;
          var enteredAmount = parseFloat(document.getElementById('amount-input').value) || 0;
          var empty = amount * cgstNo /100
          var DiScount = amount * discountAmount /100
          var netAmount = (empty + amount - DiScount) * qty;
          var balance = enteredAmount -  totalNetAmount.toFixed(2);
      
          totalAmount += amount;
          totalDiscountAmount += discountAmount;
          totalNetAmount += netAmount;
          document.getElementById('balance').textContent = balance.toFixed(2);
        });
      
        document.getElementById('product-list-length').textContent = productListLength;
        document.getElementById('total-amount').textContent = totalAmount.toFixed(2);
        document.getElementById('total-discount-amount').textContent = `${totalDiscountAmount.toFixed()}%`;
        document.getElementById('total-net-amount').textContent = totalNetAmount.toFixed(2);
        // document.getElementById('overall-total').textContent = totalNetAmount.toFixed(2);
      
        document.getElementById('discount').textContent = `${totalDiscountAmount.toFixed()}%`;
        document.getElementById('total').textContent = totalNetAmount.toFixed(2);
      }
      
      
      
      
      // Form Validation
      // Example starter JavaScript for disabling form submissions if there are invalid fields
      (function () {
        'use strict'
      
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')
      
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
          .forEach(function (form) {
            form.addEventListener('submit', function (event) {
              if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
              }
      
              form.classList.add('was-validated')
            }, false)
          })
      })()
      // Form Validation
      
      
      // Popup show
      // Popup show
      // const productNameInput = productName;
      // const sgstNoInput = sgstNo;
      // const amountInput = document.getElementById('amount');
      // const productNamePopup = document.getElementById('productNamePopup');
      // const productNameList = document.getElementById('productNameList');
      
      const tableBody = document.getElementById('table-body');
      const productNamePopup = document.getElementById('productNamePopup');
      const productNameList = document.getElementById('productNameList');
      
      const productInfo = {{ products|safe }};

      function showSuggestions(input) {
        return function () {
          const inputText = input.value.trim().toLowerCase();
      
          if (inputText.length === 0) {
            productNamePopup.style.display = 'none';
            return;
          }
      
          const suggestions = productInfo.filter(product => product.name.toLowerCase().includes(inputText));
      
          productNameList.innerHTML = '';
          suggestions.forEach(product => {
            const listItem = document.createElement('li');
            // Display product name, sgstNo, and amount in the suggestion
            listItem.innerHTML = `<span>Product Name : ${product.name}</span> - <span>SGST NO :${product.sgstNo}</span> - <span>Price : ${product.amount}</span>`;
            listItem.onclick = () => fillProductName(input, product);
            productNameList.appendChild(listItem);
          });
      
          productNamePopup.style.display = suggestions.length > 0 ? 'block' : 'none';
        };
      }
      
      function fillProductName(input, product) {
        const row = input.closest('tr');
        row.querySelector('.product-name-input').value = product.name;
        row.querySelector('.sgst-no-input').value = product.sgstNo;
        row.querySelector('.amount-input').value = product.amount;
        row.querySelector('.HSN').value = product.hns;
        row.querySelector('.qty-input').value = product.qty;
        row.querySelector('.CGST').value = product.cgst;
        row.querySelector('.discount-amount-input').value = product.discount;
        row.querySelector('.pro_id').value = product.product_id;
        
        productNamePopup.style.display = 'none';
        console.log(product.product_id)
      }
      
      window.onclick = function (event) {
        if (!event.target.matches('.product-name-input')) {
          productNamePopup.style.display = 'none';
        }
      };
      
      tableBody.addEventListener('input', function (event) {
        if (event.target.matches('.product-name-input')) {
          showSuggestions(event.target)();
        } else if (event.target.matches('.qty-input') || event.target.matches('.amount-input') || event.target.matches('.discount-amount-input')) {
          calculateRow(event.target);
        }
      });
      
      // Add functionality to dynamically add rows
      function addRow() {
        const lastRow = tableBody.lastElementChild;
        const newRow = lastRow.cloneNode(true);
      
        // Clear values in the new row
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelectorAll('.net-amount').forEach(span => span.textContent = '0.00');
      
        // Update sno in the new row
        const snoSpan = newRow.querySelector('.sno');
        snoSpan.textContent = parseInt(snoSpan.textContent) + 1;
      
        // Append the new row to the table body
        tableBody.appendChild(newRow);
      }
      
      // Function to handle click event on add row button
      // document.getElementById('add-row-btn').addEventListener('click', addRow);
      
      // Popup show
      
      // SHOW DATA CONSOLE
      // document.getElementById('payAmount').addEventListener('click', function() {
      //   // Example tabular data
      //   const tableData = [
      //     { id: 1, name: 'John', age: 25 },
      //     { id: 2, name: 'Jane', age: 30 },
      //     { id: 3, name: 'Bob', age: 28 }
      //   ];
      
      //   // Convert tabular data to JSON format
      //   const jsonData = JSON.stringify(tableData, null, 2);
      //   console.log(jsonData)
      //   // Display JSON data in the output div
      //   // document.getElementById('output').innerText = jsonData;
      // });
      
      
      // 
      
      // function selectAllRows() {
      //   // Get the table element
      //   const table = document.getElementById('product-table');
      
      //   // Get all rows in the table body
      //   const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      
      //   // Iterate through rows and set the "selected" class
      //   for (let i = 0; i < rows.length; i++) {
      //     rows[i].classList.add('selected');
      //   }
      
      //   // Log selected data to the console
      //   logSelectedData();
      // }
      
      // function logSelectedData() {
      //   // Get all rows with the "selected" class
      //   const selectedRows = document.querySelectorAll('.selected');
      
      //   // Log data for each selected row to the console
      //   selectedRows.forEach(row => {
      //     const rowData = Array.from(row.children).map(cell => cell.innerText);
      //     console.log('Selected Row Data:', rowData);
      //   });
      // }
      
      // 
      
      // Define an array to store all data
      const BillDetails = [];
      // const CustomerDetailsArray = [];
      const tableDataArray = [];
      // const TableTotal = [];
      {% comment %} const OverallDataArray = []; {% endcomment %}
      
      // Define the logTableData function
      function logTableData() {
      
        const Bill = {
          BillNo: document.getElementById('orderNumber').innerText,
          DateTimeP: document.getElementById('currentDateTime').innerText,
          GSTnum: document.getElementById('GSTon').innerText,
        }
      
        BillDetails.push(Bill);
      
        // Log the array to the console
        // console.log('Customer Data:', BillDetails);
      
        const customer = {
          CustomerName: document.getElementById('CustomerName').value,
          CustomerNumber: document.getElementById('CustomerNumber').value,
        };
      
        // Add the row data to the array
        // CustomerDetailsArray.push(customer);
        BillDetails.push(customer);
      
        // Log the array to the console
        // console.log('Customer Data:', CustomerDetailsArray);
      
        // Get all rows in the table body
        const rows = document.querySelectorAll('#product-table tbody .product-row');
      
        // Iterate through rows and build the array
        rows.forEach(row => {
          // Check if any input field in the row is filled
          const isRowFilled = Array.from(row.querySelectorAll('input')).some(input => input.value.trim() !== '');
      
          if (isRowFilled) {
            const rowData = {
              sno: row.querySelector('.sno').innerText,
              productName: row.querySelector('.product-name-input').value,
              hnsCode: row.querySelector('.HSN').value,
              qty: row.querySelector('.qty-input').value,
              sgstNo: row.querySelector('.sgst-no-input').value,
              cgstNo: row.querySelector('.CGST').value,
              amount: row.querySelector('.amount-input').value,
              discountAmount: row.querySelector('.discount-amount-input').value,
              netAmount: row.querySelector('.net-amount').innerText,
              product_id: row.querySelector('.pro_id').value
            };
      
            // Add the row data to the array
            tableDataArray.push(rowData);
          }
        });
      
        // Get data from tfoot (total row)
        const totalRowData = {
          sno: 'Total',
          productName: document.getElementById('product-list-length').innerText,
          hnsCode: document.getElementById('hns-code-total').value,
          qty: document.getElementById('qty-total').innerText,
          sgstNo: document.querySelector('.sgst-no-total').innerText,
          cgstNo: document.querySelector('.cgst-no-total').innerText,
          amount: document.getElementById('total-amount').innerText,
          discountAmount: document.getElementById('total-discount-amount').innerText,
          netAmount: document.getElementById('total-net-amount').innerText
        };
      
        // Add the total row data to the array
        // TableTotal.push(totalRowData);
        BillDetails.push(totalRowData);
      
        // Log the array to the console
        // console.log('table Data:', TableTotal);
      
        // Get data from Overall Details
        const OverallData = {
          SGST : document.getElementById('SGST').innerText,
          DisCount : document.getElementById('discount').innerText,
          Amount : document.getElementById('amount-input').value,
          CGST : document.getElementById('Cgst').innerText,
          Balance : document.getElementById('balance').innerText,
          GSTAmount : document.getElementById('gstAmount').innerText,
          DisAmount : document.getElementById('DiscountAmount').innerText,
          TotalAmount : document.getElementById('total').innerText
        }
      
        // Add the OverallData row data to the array
        // OverallDataArray.push(OverallData);
        BillDetails.push(OverallData)
      
        // Log the array to the console
        // console.log('Overall Total Data:', OverallDataArray);
        fetch('{% url "sales_get_data" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ product_ids: BillDetails,tables: tableDataArray}),
          })
          .then(response => response.json())
          .then(data => {
            console.log('Response from server:', data);
          })
          .catch(error => {
            console.error('Error during fetch:', error);
          });
          
       //  displayDataOnOutputPage(); 
        // updateDateTime()
        // updateOrderNumber();
        calculateRow();
      }
      
      // Example: Use onclick in HTML to call the logTableData function
      // Example: <button onclick="logTableData()">Log Table Data</button>
      
      
      //************************* SHOW OUTPUT OF TABLE DATA TO HTML PAGE WITH AUTO DOWNLOAD ******************//
      // Function to create and display the output.html page
      {% comment %} function displayDataOnOutputPage() {
        // Create HTML content
        const htmlContent = `
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Output Data</title>
          </head>
          <body>
            <h1>Bill Detail</h1>
            <pre>${JSON.stringify(BillDetails, null, 2)}</pre>
            <h1>Table Data</h1>
            <pre>${JSON.stringify(tableDataArray, null, 2)}</pre>
          </body>
          </html>
        `;
      
        // Create a Blob with the HTML content
        const blob = new Blob([htmlContent], { type: 'text/html' });
      
        // Create a link element
        const link = document.createElement('a');
      
        // Set the download attribute and the link's href to the Blob
        link.download = 'output.html';
        link.href = URL.createObjectURL(blob);
      
        // Append the link to the document body
        document.body.appendChild(link);
      
        // Click the link to trigger the download
        link.click();
      
        // Remove the link from the document body
        document.body.removeChild(link);
      }
       {% endcomment %}
      // *********************************** CUSTOMER DETAIL POPUP ************************************* //
        const customerData = {{ customers|safe }};

      
        let selectedSuggestionIndex = -1;
      
        function showAutocomplete(input) {
          const popup = document.getElementById('autocomplete-popup');
          const customerDropdownInput = document.getElementById('CustomerName');
          const customerNumberInput = document.getElementById('CustomerNumber');
      
          // Clear previous results
          popup.innerHTML = '';
      
          // Filter customer names and numbers based on the entire input string
          const matchingCustomers = customerData.filter(customer =>
            customer.name.toLowerCase().includes(input.toLowerCase()) ||
            customer.number.includes(input) ||
            input.includes(customer.number)
          );
      
          // Display matching customer names and numbers in the popup
          matchingCustomers.forEach((customer, index) => {
            const suggestion = document.createElement('div');
            suggestion.classList.add('suggestion');
            suggestion.innerHTML = `<strong>${customer.name}</strong> - ${customer.number}`;
            suggestion.addEventListener('mousedown', (event) => {
              // Set selected customer name and number
              customerDropdownInput.value = customer.name;
              customerNumberInput.value = customer.number;
              // Hide the popup
              popup.style.display = 'none';
              // Prevent the input from losing focus
              event.preventDefault();
            });
            popup.appendChild(suggestion);
          });
      
          // Show the popup if there are matching suggestions
          popup.style.display = matchingCustomers.length > 0 ? 'block' : 'none';
      
          // Keyboard navigation with up and down arrows
          window.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowUp' && selectedSuggestionIndex > 0) {
              selectedSuggestionIndex--;
            } else if (event.key === 'ArrowDown' && selectedSuggestionIndex < matchingCustomers.length - 1) {
              selectedSuggestionIndex++;
            } else if (event.key === 'Enter' && selectedSuggestionIndex !== -1) {
              // Fill in the customer name and number on Enter key press
              const selectedCustomer = matchingCustomers[selectedSuggestionIndex];
              customerDropdownInput.value = selectedCustomer.name;
              customerNumberInput.value = selectedCustomer.number;
              // Hide the popup
              popup.style.display = 'none';
            }
      
            // Update selected class
            const suggestions = document.querySelectorAll('.suggestion');
            suggestions.forEach((suggestion, index) => {
              if (index === selectedSuggestionIndex) {
                suggestion.classList.add('selected');
              } else {
                suggestion.classList.remove('selected');
              }
            });
          });
        }
      
        // Close the popup when clicking outside of it
        window.addEventListener('click', (event) => {
          const popup = document.getElementById('autocomplete-popup');
          const customerDropdownInput = document.getElementById('customerDropdown');
      
          if (event.target !== customerDropdownInput && event.target !== popup && !popup.contains(event.target)) {
            popup.style.display = 'none';
          }
        });
      
      // *********************************** CURRENT DATE AND TIME ************************************* //
      function updateDateTime() {
        // Get current date and time
        var currentDate = new Date();
      
        // Format the date and time as a string without AM/PM
        var options = { 
            year: 'numeric', 
            month: 'numeric', 
            day: 'numeric', 
            hour: 'numeric', 
            minute: 'numeric', 
            second: 'numeric', 
            hour12: false // Set to false to display 24-hour format
        };
        var formattedDateTime = currentDate.toLocaleString(undefined, options);
      
        // Display the formatted date and time in the HTML element with id "currentDateTime"
        document.getElementById("currentDateTime").textContent = formattedDateTime;
      
        console.log(formattedDateTime);
    }
    
    // Call the updateDateTime function when the page is loaded or refreshed
    updateDateTime();
    
      
      // *********************************** AUTO BILL NUMBER GENERATE ************************************* //
      
      function updateOrderNumber() {
        // Check if the order number is stored in localStorage
        if (localStorage.getItem('orderNumber') === null) {
          // If not, initialize it to 1
          localStorage.setItem('orderNumber', '1');
        } else {
          // If yes, increment the order number
          var currentOrderNumber = parseInt(localStorage.getItem('orderNumber'));
          currentOrderNumber++;
          localStorage.setItem('orderNumber', currentOrderNumber.toString());
        }
      
        // Display the updated order number in the HTML element with id "orderNumber"
        document.getElementById("orderNumber").textContent = "SM 0" + localStorage.getItem('orderNumber');
      }
      
      // Call the updateOrderNumber function when the page is loaded or refreshed
      updateOrderNumber();



    </script>












    {% comment %} <script src="{% static 'js/product/bill_manage.js' %}"></script> {% endcomment %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</body>

</html>